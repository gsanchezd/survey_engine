<div class="matrix-container">
    <table class="matrix-table">
      <thead>
        <tr>
          <th class="matrix-row-header"></th>
          <% question.options.ordered.each do |option| %>
            <th class="matrix-column-header">
              <span class="column-label"><%= option.option_text %></span>
            </th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% question.matrix_sub_questions.ordered.each do |sub_question| %>
          <% existing_answer = answers[sub_question.id] if defined?(answers) %>
          <tr class="matrix-row" data-row-id="<%= sub_question.id %>">
            <td class="matrix-row-label">
              <%= sub_question.matrix_row_text %>
              <% if sub_question.required? %>
                <span class="required-indicator">*</span>
              <% end %>
            </td>
            <% question.options.ordered.each do |option| %>
              <td class="matrix-cell">
                <%= radio_button_tag "answers[#{sub_question.id}][option_id]", 
                                   option.id, 
                                   existing_answer&.options&.include?(option),
                                   id: "matrix_#{sub_question.id}_option_#{option.id}",
                                   class: "matrix-radio",
                                   required: sub_question.required?,
                                   data: { 
                                     question_id: sub_question.id,
                                     option_id: option.id 
                                   } %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if question.help_text.present? %>
    <p class="question-help-text"><%= question.help_text %></p>
  <% end %>

  <!-- Show current answers if they exist -->
  <% if defined?(answers) && question.matrix_sub_questions.any? { |sq| answers[sq.id] } %>
    <div class="survey-current-answer">
      <strong>Respuestas actuales:</strong>
      <ul class="matrix-answers-list">
        <% question.matrix_sub_questions.ordered.each do |sub_question| %>
          <% if answers[sub_question.id] %>
            <li>
              <strong><%= sub_question.matrix_row_text %>:</strong> 
              <%= answers[sub_question.id].display_value %>
            </li>
          <% end %>
        <% end %>
      </ul>
    </div>
  <% end %>