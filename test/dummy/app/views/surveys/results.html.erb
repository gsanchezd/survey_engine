<%= link_to "← Back to Surveys", surveys_path, style: "text-decoration: none; color: #007cba;" %>

<h1>📊 Survey Results: <%= @survey.title %></h1>
<p style="color: #666; font-size: 1.1em;"><%= @survey.description %></p>

<!-- Overall Statistics -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
  <h2 style="margin: 0 0 15px 0; color: #333;">📈 Overall Statistics</h2>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    <div style="text-align: center; padding: 15px; background: white; border-radius: 5px;">
      <div style="font-size: 2em; font-weight: bold; color: #007cba;"><%= @stats[:total_participants] %></div>
      <div style="color: #666;">Total Participants</div>
    </div>
    
    <div style="text-align: center; padding: 15px; background: white; border-radius: 5px;">
      <div style="font-size: 2em; font-weight: bold; color: #28a745;"><%= @stats[:completed_responses] %></div>
      <div style="color: #666;">Completed Responses</div>
    </div>
    
    <div style="text-align: center; padding: 15px; background: white; border-radius: 5px;">
      <div style="font-size: 2em; font-weight: bold; color: #6f42c1;"><%= @stats[:completion_rate] %>%</div>
      <div style="color: #666;">Completion Rate</div>
    </div>
    
    <div style="text-align: center; padding: 15px; background: white; border-radius: 5px;">
      <div style="font-size: 2em; font-weight: bold; color: #fd7e14;"><%= time_duration_in_words(@stats[:average_completion_time].to_i) %></div>
      <div style="color: #666;">Avg. Completion Time</div>
    </div>
  </div>
</div>

<% if @responses.any? %>
  <!-- Question-by-Question Analysis -->
  <div style="margin: 30px 0;">
    <h2>📋 Question Analysis</h2>
    
    <% @questions.each_with_index do |question, index| %>
      <% analytics = @question_analytics[question.id] %>
      <div style="border: 1px solid #dee2e6; padding: 20px; margin: 20px 0; border-radius: 8px; background: white;">
        <h3 style="margin: 0 0 15px 0; color: #333;">
          <%= index + 1 %>. <%= question.title %>
          <span style="font-size: 0.8em; color: #666;">(<%= analytics[:response_count] %> responses)</span>
        </h3>
        
        <% if question.description.present? %>
          <p style="color: #666; margin: 5px 0 15px 0; font-style: italic;"><%= question.description %></p>
        <% end %>
        
        <% case analytics[:type] %>
        <% when 'text' %>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Text Responses (<%= analytics[:responses].count %>):</strong>
            <% if analytics[:responses].any? %>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <% analytics[:responses].first(10).each do |response| %>
                  <li style="margin: 8px 0; background: white; padding: 10px; border-radius: 3px;">
                    "<%= response %>"
                  </li>
                <% end %>
                <% if analytics[:responses].count > 10 %>
                  <li style="color: #666; font-style: italic;">
                    ... and <%= analytics[:responses].count - 10 %> more responses
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p style="color: #666; margin: 10px 0;">No text responses yet.</p>
            <% end %>
          </div>
          
        <% when 'numeric' %>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0;">
              <div style="text-align: center; background: white; padding: 10px; border-radius: 3px;">
                <div style="font-weight: bold; color: #28a745;"><%= analytics[:average] %></div>
                <div style="font-size: 0.9em; color: #666;">Average</div>
              </div>
              <div style="text-align: center; background: white; padding: 10px; border-radius: 3px;">
                <div style="font-weight: bold; color: #dc3545;"><%= analytics[:min] %></div>
                <div style="font-size: 0.9em; color: #666;">Minimum</div>
              </div>
              <div style="text-align: center; background: white; padding: 10px; border-radius: 3px;">
                <div style="font-weight: bold; color: #007cba;"><%= analytics[:max] %></div>
                <div style="font-size: 0.9em; color: #666;">Maximum</div>
              </div>
            </div>
            
            <% if analytics[:distribution].any? %>
              <div style="margin: 15px 0;">
                <strong>Response Distribution:</strong>
                <div style="margin: 10px 0;">
                  <% analytics[:distribution].sort.each do |value, count| %>
                    <div style="display: flex; align-items: center; margin: 5px 0;">
                      <span style="width: 60px; font-weight: bold;"><%= value %>:</span>
                      <div style="background: #e9ecef; height: 20px; flex: 1; margin: 0 10px; border-radius: 10px; overflow: hidden;">
                        <div style="background: #007cba; height: 100%; width: <%= (count.to_f / analytics[:response_count] * 100).round(1) %>%; border-radius: 10px;"></div>
                      </div>
                      <span style="width: 60px; text-align: right;"><%= count %> (<%= (count.to_f / analytics[:response_count] * 100).round(1) %>%)</span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          
        <% when 'boolean' %>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="text-align: center; background: white; padding: 15px; border-radius: 5px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;"><%= analytics[:yes_count] %></div>
                <div style="color: #666;">Yes (<%= analytics[:yes_percentage] %>%)</div>
              </div>
              <div style="text-align: center; background: white; padding: 15px; border-radius: 5px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;"><%= analytics[:no_count] %></div>
                <div style="color: #666;">No (<%= (100 - analytics[:yes_percentage]).round(1) %>%)</div>
              </div>
            </div>
          </div>
          
        <% when 'choice' %>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <% if analytics[:option_counts].any? %>
              <strong>Option Selection:</strong>
              <div style="margin: 10px 0;">
                <% analytics[:option_counts].sort_by { |_, count| -count }.each do |option_text, count| %>
                  <div style="display: flex; align-items: center; margin: 8px 0;">
                    <span style="width: 200px; font-weight: bold;"><%= option_text %>:</span>
                    <div style="background: #e9ecef; height: 20px; flex: 1; margin: 0 10px; border-radius: 10px; overflow: hidden;">
                      <div style="background: #6f42c1; height: 100%; width: <%= (count.to_f / analytics[:response_count] * 100).round(1) %>%; border-radius: 10px;"></div>
                    </div>
                    <span style="width: 80px; text-align: right;"><%= count %> (<%= (count.to_f / analytics[:response_count] * 100).round(1) %>%)</span>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <% if analytics[:other_responses].any? %>
              <div style="margin: 15px 0;">
                <strong>"Other" Responses:</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <% analytics[:other_responses].first(5).each do |other_response| %>
                    <li style="margin: 5px 0; background: white; padding: 8px; border-radius: 3px;">
                      "<%= other_response %>"
                    </li>
                  <% end %>
                  <% if analytics[:other_responses].count > 5 %>
                    <li style="color: #666; font-style: italic;">
                      ... and <%= analytics[:other_responses].count - 5 %> more "other" responses
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <!-- Export Options -->
  <div style="text-align: center; margin: 40px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <h3>📥 Export Results</h3>
    <p style="color: #666;">Download survey data for further analysis</p>
    
    <%= link_to "Download CSV", results_survey_path(@survey, format: :csv), 
        style: "background: #28a745; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 0 10px;" %>
    <%= link_to "Download JSON", results_survey_path(@survey, format: :json), 
        style: "background: #007cba; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 0 10px;" %>
  </div>
  
<% else %>
  <!-- No Responses Yet -->
  <div style="text-align: center; padding: 60px 20px; color: #666;">
    <h3>📭 No Responses Yet</h3>
    <p>This survey hasn't received any completed responses yet.</p>
    <p>Once participants start completing the survey, their results will appear here.</p>
  </div>
<% end %>